# Векторизация шумного параллелограмма методом преобразования Хафа

## Проблема:

Имеется ML-based алгоритм для распознавания форм объектов. Одна из задач этого алгоритма - векторизовать шумный параллелограмм заданный набором точек (координатами). Необходимо разработать алгоритм, преобразующий каждый такой шумный параллелограмм в набор из 4-х точек, определяющих соответствующий идеальный параллелограмм.

### Пример шумных параллелограммов

![image-20200425083332329](/home/egor/.config/Typora/typora-user-images/image-20200425083332329.png)![image-20200425083411675](/home/egor/.config/Typora/typora-user-images/image-20200425083411675.png)

## Решение:

Применить к точкам заданного параллелограмма, т.н. Преобразование Хафа ([Hough Transform](https://en.wikipedia.org/wiki/Hough_transform)) -  вычислительный  алгоритм, применяемый для параметрической идентификации геометрических элементов растрового изображения. Метод предназначен для поиска объектов, принадлежащих определённому классу фигур, с использованием процедуры голосования.

### Шаг 1 -  Построить Аккумулятор Хафа

Для каждой данной точки $(x_i, y_i)$ строится семейство, проходящих через неё прямых $C_i(\rho, \theta)$, заданных в полярной системе координат параметрами $\rho$  и $\theta$ с помощью уравнения: 

$rho = x_i\cos{\theta} + y_i\sin{\theta}$  (1).

 Каждой такой прямой в полярной системе координат соответствует точка $(\rho ,\theta)$, а каждому семейству таких прямых, проходящих через одну точку соответствует синусоида (это следует из ур-я (1)).

Осуществив подобную процедуру относительно каждой данной точки, заполняется т.н. *Аккумуляторе Хафа*: 2-D массив, строки и столбцы которого, соответствуют значению полярных координат $\rho$  и $\theta$ в . Процесс заполнения аккумулятора называется "голосованием", т.к. мы подсчитываем сколько "голосов" получила каждая точка $(\rho ,\theta)$ . Чем больше голосов набрала точка в полярной системе координат тем больше точек лежат на, соответствующей ей, прямой в декартовой  системе координат. Ниже представлена визуализация подобного массива для идеального  параллелограмма:

![image-20200425093017846](/home/egor/.config/Typora/typora-user-images/image-20200425093017846.png)

### Шаг 2 - Найти пиковые значения в аккумуляторе

Как было отмечено выше: чем больше ячейка в аккумуляторе набрала голосов, тем больше точек контура пересекает, соответствующая ей прямая. Тогда можно из аккумулятора взять те ячейки, которые набрали минимальное допустимое кол-во голосов (минимальное кол-во точек, которое должна пересекать прямая) и предположить, что среди полученного множества прямых есть стороны искомого параллелограмма. Для сплошного контура, где все точки лежат очень близко и на примерно одинаковом расстоянии друг от друга, минимальное кол-во голосов можно принять за минимальную допустимую высоту параллелограмма. В случае же с шумными параллелограммами порого приходится устанавливать довольно низкий: 3-4 точки. Очевидно при таком низком пороге бы получим много лишних прямых, и потому все полученные на данном шаге прямые необходимо "отсеять", проверив являются ли они сторонами параллелограмма

### Шаг 3 - Поиск сторон параллелограмма

В [данной работе](http://www.inf.ufrgs.br/~crjung/papers/paper_1125.pdf) представлен список условий, при которых прямые, полученные преобразованием Хафа, можно рассматривать, как стороны параллелограмма. Если коротко, то проверяются такие условия:

* Находятся пары параллельных прямых $P_k$ с минимальной допустимой разницей в "длине" (кол-во голосов набранных на шаге 2)
* Из этих параллельных пар собираются  пары смежных сторон  $P_k$ и  $P_l$ с минимальным допустимым углом между ними и минимальной высотой параллелограмма, образуемого такими сторонами
* Периметр обнаруженных параллелограммов сравнивается с периметром полигона, образуемого данными кравевыми точками. Параллелограмм с минимальной разницей принимается за искомы идеальный паралелограмм

### Шаг 4 - Поиск вершин паралелограмма

Из шага 3 мы получаем 4 прямые, заданные в параметрами $\rho$  и $\theta$. Подставив параметры в ур-е 1 и приняв x. y за неизвестные, получим СЛАУ решение, которой даст точки пересечения прямых - вершины соответсвующего параллелограмма.



## Полученные результаты

Алгоритм успешно векторизует шумные параллелограммы разной сложности. Точность обнаружения на данный момент зависит от того, насколько удачно были подобраны константы аппроксимации (минимальные допустимые значения некоторых значений получаемых в ходе отсеивания ложных результатов)   Пример результатов работы алгоритма представлен на рисунках ниже:
![img](https://sun9-31.userapi.com/iK65P8CcLGf--pJ287KS42wC8XcGyMjcJjFX9g/IXH6Hf1E2eY.jpg)![img](https://sun9-47.userapi.com/9RbNe1ICMTpDhpM--uHXv6bsaWdgYud2_jonbQ/w2BcxF38wkU.jpg)



##  ![img](https://sun9-52.userapi.com/ImV4RK7A9Y5e-UJfpLUq6FTXFm0ZR-IVykUJLA/z9HGqthsmvs.jpg)![img](https://sun9-9.userapi.com/k9xqJTgDWbQFkyDoNmNV3aC5ZzNsSqtkyt5tQA/jcrxVFx3u3Q.jpg)